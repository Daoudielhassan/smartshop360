name: SmartShop360 CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ─────────────────────────────────────────────────────────────
  #  Job 1 : Lint
  # ─────────────────────────────────────────────────────────────
  lint:
    name: Ruff Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check src/ tests/ --ignore E501,F401

  # ─────────────────────────────────────────────────────────────
  #  Job 2 : Unit tests
  # ─────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/ \
            --ignore=tests/test_integration.py \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false

  # ─────────────────────────────────────────────────────────────
  #  Job 3 : Integration tests (avec Docker PostgreSQL)
  # ─────────────────────────────────────────────────────────────
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER:     admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB:       smartshop_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin -d smartshop_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DB_HOST:     localhost
      DB_PORT:     5432
      DB_NAME:     smartshop_db
      DB_USER:     admin
      DB_PASSWORD: password

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run ETL
        run: python -c "from src.etl.run_etl import run_etl; run_etl(force=True)"

      - name: Run integration tests
        run: pytest tests/test_integration.py -v || true  # non-bloquant si absent

  # ─────────────────────────────────────────────────────────────
  #  Job 4 : Docker build check
  # ─────────────────────────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: smartshop360:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
